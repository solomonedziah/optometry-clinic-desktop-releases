name: Publish Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Create or update release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const { owner, repo } = context.repo;

            async function createRelease() {
              return github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: tag,
                draft: false,
                prerelease: false,
                make_latest: 'true'
              });
            }

            let releaseResponse;
            try {
              releaseResponse = await createRelease();
            } catch (error) {
              if (error.status === 422 && error.message && error.message.includes('already_exists')) {
                const existing = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
                releaseResponse = await github.rest.repos.updateRelease({
                  owner,
                  repo,
                  release_id: existing.data.id,
                  tag_name: tag,
                  name: tag,
                  draft: false,
                  prerelease: false,
                  make_latest: 'true'
                });
              } else {
                throw error;
              }
            }

            core.setOutput('upload_url', releaseResponse.data.upload_url);
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload installer asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: OptometryClinicSetup.exe
          asset_name: OptometryClinicSetup.exe
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
